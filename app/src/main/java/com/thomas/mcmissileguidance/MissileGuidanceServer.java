package com.thomas.mcmissileguidance;

import com.chrisbesch.mcmissile.guidance.GuidanceGrpc.GuidanceImplBase;
import com.chrisbesch.mcmissile.guidance.ControlInput;
import com.chrisbesch.mcmissile.guidance.Missile;
import com.chrisbesch.mcmissile.guidance.HealthRequest;
import com.chrisbesch.mcmissile.guidance.HealthResponse;
import com.chrisbesch.mcmissile.guidance.MissileState;
import com.chrisbesch.mcmissile.guidance.MissileHardwareConfig;

import io.grpc.Grpc;
import io.grpc.InsecureServerCredentials;
import io.grpc.Server;
import io.grpc.ServerBuilder;
import io.grpc.stub.StreamObserver;
import java.io.IOException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.TimeUnit;
import java.util.logging.Level;
import java.util.logging.Logger;


public class MissileGuidanceServer {
  private static final Logger logger = Logger.getLogger(MissileGuidanceServer.class.getName());

  private final int port;
  private final Server server;

  public MissileGuidanceServer(int port) {
    this.port = port;
    server = Grpc.newServerBuilderForPort(port, InsecureServerCredentials.create()).addService(new GuidanceService()).build();
  }

  /** Start serving requests. */
  public void start() throws IOException {
    server.start();
    logger.info("Server started, listening on " + port);
    Runtime.getRuntime().addShutdownHook(new Thread() {
      @Override
      public void run() {
        // Use stderr here since the logger may have been reset by its JVM shutdown hook.
        System.err.println("*** shutting down gRPC server since JVM is shutting down");
        try {
          MissileGuidanceServer.this.stop();
        } catch (InterruptedException e) {
          e.printStackTrace(System.err);
        }
        System.err.println("*** server shut down");
      }
    });
  }

  /** Stop serving requests and shutdown resources. */
  public void stop() throws InterruptedException {
    if (server != null) {
      server.shutdown().awaitTermination(30, TimeUnit.SECONDS);
    }
  }

  /**
   * Await termination on the main thread since the grpc library uses daemon threads.
   */
  private void blockUntilShutdown() throws InterruptedException {
    if (server != null) {
      server.awaitTermination();
    }
  }

  public static void main(String[] args) throws Exception {
    MissileGuidanceServer server = new MissileGuidanceServer(42069);
    server.start();
    server.blockUntilShutdown();
  }

  private static class GuidanceService extends GuidanceImplBase {

    double[] angleToGravityAngle = {-90.0D,-89.8500000190386D,-89.70000015230882D,-89.5500005140428D,-89.40000121847339D,-89.25000237983492D,-89.10000411236337D,-88.95000653029686D,-88.80000974787619D,-88.6500138793452D,-88.5000190389512D,-88.35002534094535D,-88.2000328995832D,-88.05004182912518D,-87.90005224383675D,-87.75006425798921D,-87.60007798585981D,-87.45009354173236D,-87.30011103989764D,-87.1501305946538D,-87.00015232030685D,-86.85017633117103D,-86.70020274156923D,-86.55023166583351D,-86.40026321830547D,-86.25029751333672D,-86.10033466528924D,-85.95037478853591D,-85.8004179974609D,-85.65046440646002D,-85.50051412994134D,-85.35056728232546D,-85.20062397804595D,-85.05068433154993D,-84.90074845729829D,-84.75081646976628D,-84.60088848344388D,-84.4509646128362D,-84.30104497246406D,-84.15112967686413D,-84.0012188405897D,-83.85131257821085D,-83.701411004315D,-83.55151423350735D,-83.40162238041118D,-83.25173555966849D,-83.10185388594022D,-82.95197747390672D,-82.80210643826837D,-82.65224089374571D,-82.5023809550801D,-82.35252673703403D,-82.20267835439152D,-82.05283592195872D,-81.90299955456408D,-81.75316936705902D,-81.60334547431816D,-81.45352799123982D,-81.30371703274653D,-81.15391271378526D,-81.00411514932804D,-80.85432445437225D,-80.70454074394104D,-80.55476413308386D,-80.40499473687676D,-80.25523267042296D,-80.10547804885304D,-79.95573098732554D,-79.80599160102736D,-79.65626000517408D,-79.5065363150105D,-79.35682064581096D,-79.20711311287977D,-79.05741383155173D,-78.90772291719234D,-78.75804048519846D,-78.60836665099852D,-78.45870153005302D,-78.30904523785496D,-78.15939788993018D,-78.00975960183784D,-77.86013048917084D,-77.71051066755611D,-77.56090025265517D,-77.41129936016446D,-77.26170810581574D,-77.11212660537653D,-76.96255497465046D,-76.8129933294778D,-76.66344178573571D,-76.51390045933874D,-76.36436946623921D,-76.21484892242758D,-76.06533894393293D,-75.91583964682327D,-75.76635114720601D,-75.61687356122835D,-75.46740700507755D,-75.31795159498164D,-75.1685074472094D,-75.01907467807112D,-74.86965340391879D,-74.72024374114653D,-74.57084580619107D,-74.42145971553201D,-74.27208558569231D,-74.12272353323867D,-73.97337367478184D,-73.82403612697712D,-73.67471100652466D,-73.52539843017D,-73.37609851470417D,-73.22681137696432D,-73.0775371338341D,-72.92827590224385D,-72.77902779917122D,-72.62979294164136D,-72.4805714467274D,-72.33136343155084D,-72.18216901328186D,-72.03298830913975D,-71.88382143639332D,-71.73466851236113D,-71.58552965441203D,-71.43640497996543D,-71.28729460649176D,-71.13819865151274D,-70.9891172326018D,-70.84005046738447D,-70.69099847353873D,-70.54196136879536D,-70.39293927093831D,-70.24393229780505D,-70.09494056728707D,-69.94596419732996D,-69.7970033059341D,-69.64805801115475D,-69.49912843110255D,-69.35021468394386D,-69.2013168879011D,-69.05243516125309D,-68.90356962233543D,-68.75472038954078D,-68.60588758131945D,-68.45707131617937D,-68.30827171268677D,-68.15948888946637D,-68.0107229652017D,-67.86197405863557D,-67.7132422885703D,-67.56452777386815D,-67.41583063345158D,-67.2671509863036D,-67.11848895146824D,-66.9698446480506D,-66.82121819521755D,-66.67260971219781D,-66.52401931828226D,-66.3754471328245D,-66.22689327524094D,-66.07835786501128D,-65.92984102167878D,-65.78134286485054D,-65.63286351419795D,-65.48440308945683D,-65.33596171042797D,-65.18753949697727D,-65.03913656903609D,-64.89075304660167D,-64.7423890497373D,-64.59404469857276D,-64.4457201133045D,-64.2974154141961D,-64.14913072157844D,-64.00086615585008D,-63.852621837477585D,-63.70439788699572D,-63.556194425007845D,-63.40801157218629D,-63.259849449272366D,-63.11170817707703D,-62.96358787648087D,-62.815488668434575D,-62.66741067395919D,-62.51935401414634D,-62.37131881015862D,-62.22330518322977D,-62.075313254665026D,-61.927343145841455D,-61.77939497820808D,-61.63146887328631D,-61.48356495267011D,-61.33568333802629D,-61.187824151094915D,-61.03998751368933D,-60.892173547696665D,-60.74438237507794D,-60.59661411786837D,-60.448868898177736D,-60.301146838190405D,-60.153448060165914D,-60.005772686438924D,-59.85812083941961D,-59.710492641593945D,-59.562888215523856D,-59.4153076838476D,-59.26775116927983D,-59.12021879461201D,-58.97271068271259D,-58.825226956527146D,-58.6777677390789D,-58.5303331534686D,-58.382923322874966D,-58.235538370554934D,-58.088178419843736D,-57.940843594155304D,-57.79353401698238D,-57.64624981189669D,-57.49899110254937D,-57.351758012670935D,-57.204550666071704D,-57.057369186641864D,-56.9102136983517D,-56.76308432525196D,-56.61598119147381D,-56.46890442122926D,-56.32185413881121D,-56.17483046859372D,-56.02783353503223D,-55.880863462663655D,-55.73392037610672D,-55.587004400062D,-55.440115659312156D,-55.29325427872226D,-55.146420383239715D,-54.99961409789465D,-54.85283554779996D,-54.70608485815157D,-54.55936215422857D,-54.41266756139336D,-54.26600120509189D,-54.119363210853706D,-53.97275370429219D,-53.82617281110474D,-53.67962065707283D,-53.5330973680623D,-53.38660307002337D,-53.24013788899081D,-53.09370195108417D,-52.94729538250782D,-52.800918309551186D,-52.654570858588805D,-52.508253156080436D,-52.36196532857132D,-52.21570750269215D,-52.06947980515934D,-51.92328236277503D,-51.77711530242724D,-51.63097875109003D,-51.484872835823516D,-51.33879768377411D,-51.1927534221745D,-51.046740178343846D,-50.900758079687805D,-50.754807253698665D,-50.60888782795548D,-50.46299993012404D,-50.31714368795713D,-50.17131922929446D,-50.02552668206282D,-49.87976617427613D,-49.73403783403556D,-49.588341789529544D,-49.442678169033904D,-49.297047100911854D,-49.15144871361413D,-49.00588313567895D,-48.860350495732206D,-48.714850922487436D,-48.56938454474582D,-48.42395149139632D,-48.27855189141573D,-48.13318587386856D,-47.987853567907315D,-47.84255510277228D,-47.69729060779176D,-47.5520602123819D,-47.406864046046934D,-47.26170223837897D,-47.11657491905817D,-46.97148221785271D,-46.82642426461881D,-46.681401189300615D,-46.536413121930416D,-46.3914601926284D,-46.24654253160286D,-46.10166026915004D,-45.95681353565418D,-45.81200246158749D,-45.667227177510085D,-45.52248781407007D,-45.377784502003394D,-45.23311737213383D,-45.088486555373066D,-44.943892182720454D,-44.79933438526312D,-44.65481329417589D,-44.51032904072124D,-44.36588175624915D,-44.22147157219714D,-44.07709862009022D,-43.932763031540695D,-43.788464938248254D,-43.64420447199979D,-43.49998176466936D,-43.35579694821801D,-43.21165015469388D,-43.067541516231884D,-42.9234711650538D,-42.77943923346805D,-42.635445853869655D,-42.49149115874007D,-42.347575280647156D,-42.20369835224502D,-42.05986050627382D,-41.91606187555975D,-41.77230259301487D,-41.62858279163693D,-41.4849026045093D,-41.34126216480079D,-41.19766160576547D,-41.05410106074258D,-40.91058066315637D,-40.76710054651585D,-40.623660844414744D,-40.48026169053124D,-40.336903218627825D,-40.19358556255116D,-40.05030885623186D,-39.90707323368423D,-39.763878829006224D,-39.62072577637912D,-39.477614210067394D,-39.3345442644185D,-39.19151607386259D,-39.0485297729124D,-38.90558549616297D,-38.762683378291406D,-38.61982355405676D,-38.477006158299574D,-38.33423132594188D,-38.191499191986836D,-38.04880989151845D,-37.90616355970141D,-37.76356033178077D,-37.6210003430817D,-37.478483729009206D,-37.336010625047884D,-37.193581166761625D,-37.05119548979328D,-36.908853729864504D,-36.766556022775326D,-36.624302504403914D,-36.48209331070626D,-36.33992857771588D,-36.197808441543486D,-36.05573303837668D,-35.91370250447962D,-35.771716976192685D,-35.629776589932156D,-35.487881482189856D,-35.34603178953287D,-35.204227648603066D,-35.06246919611689D,-34.920756568864874D,-34.779089903711345D,-34.63746933759405D,-34.49589500752374D,-34.35436705058388D,-34.2128856039301D,-34.07145080478994D,-33.93006279046241D,-33.78872169831758D,-33.6474276657962D,-33.50618083040922D,-33.36498132973743D,-33.223829301430996D,-33.082724883209075D,-32.941668212859355D,-32.800659428237545D,-32.659698667267065D,-32.51878606793845D,-32.377921768308994D,-32.237105906502286D,-32.09633862070759D,-31.955620049179593D,-31.814950330237743D,-31.67432960226583D,-31.53375800371152D,-31.393235673085794D,-31.252762748962496D,-31.112339369977775D,-30.971965674829633D,-30.831641802277307D,-30.69136789114081D,-30.5511440803004D,-30.410970508696035D,-30.27084731532675D,-30.13077463925023D,-29.990752619582118D,-29.8507813954956D,-29.710861106220698D,-29.57099189104376D,-29.431173889306894D,-29.291407240407317D,-29.15169208379679D,-29.01202855898108D,-28.872416805519233D,-28.73285696302308D,-28.59334917115651D,-28.453893569634932D,-28.31449029822457D,-28.175139496741924D,-28.035841305053026D,-27.89659586307282D,-27.757403310764527D,-27.618263788138975D,-27.479177435253938D,-27.34014439221341D,-27.201164799166992D,-27.062238796309167D,-26.9233665238786D,-26.784548122157442D,-26.64578373147069D,-26.507073492185327D,-26.36841754470975D,-26.22981602949296D,-26.091269087023832D,-25.952776857830475D,-25.814339482479284D,-25.67595710157441D,-25.53762985575687D,-25.39935788570379D,-25.261141332127703D,-25.122980335775694D,-24.98487503742864D,-24.846825577900447D,-24.708832098037217D,-24.570894738716472D,-24.43301364084629D,-24.29518894536457D,-24.157420793238135D,-24.01970932546192D,-23.88205468305819D,-23.744457007075557D,-23.606916438588325D,-23.46943311869546D,-23.332007188519814D,-23.19463878920724D,-23.057328061925663D,-22.920075147864292D,-22.78288018823266D,-22.64574332425973D,-22.50866469719302D,-22.37164444829763D,-22.234682718855414D,-22.097779650164007D,-21.960935383535855D,-21.824150060297345D,-21.68742382178781D,-21.550756809358614D,-21.414149164372144D,-21.277601028200923D,-21.141112542226544D,-21.004683847838745D,-20.86831508643441D,-20.73200639941658D,-20.59575792819344D,-20.45956981417735D,-20.323442198783752D,-20.18737522343023D,-20.051369029535454D,-19.9154237585181D,-19.77953955179591D,-19.643716550784518D,-19.507954896896507D,-19.372254731540266D,-19.23661619611896D,-19.101039432029452D,-18.965524580661192D,-18.830071783395173D,-18.69468118160278D,-18.559352916644734D,-18.42408712986995D,-18.288883962614406D,-18.15374355620008D,-18.018666051933753D,-17.883651591105888D,-17.74870031498951D,-17.61381236483899D,-17.478987881888997D,-17.3442270073532D,-17.20952988242317D,-17.07489664826721D,-16.940327446029087D,-16.805822416826935D,-16.67138170175201D,-16.53700544186746D,-16.402693778207148D,-16.268446851774364D,-16.134264803540702D,-16.00014777444473D,-15.866095905390791D,-15.732109337247751D,-15.598188210847672D,-15.464332666984696D,-15.330542846413607D,-15.19681888984869D,-15.063160937962357D,-14.929569131383873D,-14.796043610698083D,-14.662584516444088D,-14.529191989113954D,-14.395866169151358D,-14.262607196950261D,-14.12941521285361D,-13.996290357151983D,-13.863232770082218D,-13.730242591826125D,-13.597319962509014D,-13.464465022198432D,-13.331677910902751D,-13.198958768569769D,-13.066307735085356D,-12.933724950272024D,-12.801210553887556D,-12.668764685623575D,-12.536387485104154D,-12.40407909188438D,-12.271839645448885D,-12.139669285210516D,-12.007568150508787D,-11.87553638060847D,-11.74357411469818D,-11.611681491888813D,-11.47985865121221D,-11.348105731619581D,-11.216422871980047D,-11.084810211079182D,-10.953267887617459D,-10.821796040208833D,-10.690394807379178D,-10.559064327564757D,-10.427804739110767D,-10.296616180269725D,-10.165498789200015D,-10.034452703964327D,-9.90347806252806D,-9.772575002757858D,-9.641743662419955D,-9.510984179178678D,-9.380296690594855D,-9.249681334124253D,-9.11913824711597D,-8.988667566810825D,-8.858269430339828D,-8.72794397472252D,-8.5976913368654D,-8.467511653560294D,-8.337405061482709D,-8.207371697190258D,-8.077411697121002D,-7.947525197591782D,-7.8177123347966635D,-7.687973244805169D,-7.558308063560682D,-7.428716926878821D,-7.299199970445679D,-7.169757329816261D,-7.0403891404126915D,-6.911095537522601D,-6.7818766562974195D,-6.652732631750663D,-6.523663598756265D,-6.394669692046822D,-6.265751046211922D,-6.136907795696386D,-6.0081400747985905D,-5.879448017668688D,-5.750831758306908D,-5.622291430561803D,-5.493827168128474D,-5.365439104546885D,-5.237127373200032D,-5.1088921073122355D,-4.980733439947324D,-4.852651504006946D,-4.724646432228658D,-4.596718357184287D,-4.468867411278035D,-4.341093726744718D,-4.213397435648008D,-4.085778669878594D,-3.958237561152333D,-3.8307742410085335D,-3.7033888408080604D,-3.576081491731516D,-3.4488523247775227D,-3.3217014707607007D,-3.1946290603099863D,-3.067635223866745D,-2.940720091682896D,-2.813883793819143D,-2.687126460143013D,-2.560448220327065D,-2.433849203847023D,-2.3073295399798974D,-2.18088935780213D,-2.0545287861876798D,-1.928247953806204D,-1.8020469891210962D,-1.6759260203876878D,-1.5498851756513006D,-1.4239245827453386D,-1.298044369289463D,-1.1722446626875922D,-1.0465255901260762D,-0.9208872785717476D,-0.7953298547700238D,-0.6698534452429624D,-0.5444581762873613D,-0.41914417397286285D,-0.293911564139969D,-0.16876047239814254D,-0.04369102412388872D,0.08129665554123226D,0.20620244169248922D,0.3310262096639617D,0.45576783503046925D,0.5804271936095162D,0.7050041614632699D,0.8294986149004909D,0.9539104304784816D,1.078239485005094D,1.2024856555406342D,1.3266488193998673D,1.4507288541539796D,1.5747256376325238D,1.698639047925436D,1.8224689633849673D,1.946215262627691D,2.069877824536463D,2.1934565282624194D,2.3169512532269523D,2.440361879123689D,2.5636882859204966D,2.686930353861455D,2.81008796346885D,2.9331609955451885D,3.05614933117515D,3.1790528517276204D,3.301871438857692D,3.4246049745086125D,3.547253340913855D,3.6698164205990533D,3.7922940963840577D,3.9146862513849117D,4.036992769015841D,4.159213532991311D,4.281348427327978D,4.40339733634673D,4.525360144674684D,4.647236737247189D,4.769026999309852D,4.8907308164205245D,5.01234807445134D,5.13387865959069D,5.255322458345286D,5.376679357542099D,5.497949244330438D,5.619132006183936D,5.740227530902537D,5.8612357066145355D,5.982156421778599D,6.1029895651857204D,6.223735025961313D,6.34439269356714D,6.464962457803359D,6.58544420881054D,6.705837837071653D,6.826143233414092D,6.946360289011657D,7.066488895386574D,7.186528944411514D,7.30648032831156D,7.426342939666245D,7.54611667141152D,7.665801416841769D,7.78539706961182D,7.904903523738905D,8.024320673604697D,8.143648413957258D,8.262886639913065D,8.382035246958981D,8.501094130954238D,8.620063188132455D,8.73894231510356D,8.857731408855825D,8.976430366757828D,9.095039086560405D,9.213557466398662D,9.331985404793906D,9.450322800655634D,9.568569553283506D,9.686725562369297D,9.804790727998837D,9.922764950653997D,10.040648131214626D,10.158440170960503D,10.276140971573286D,10.393750435138445D,10.51126846414721D,10.628694961498518D,10.746029830500913D,10.863272974874489D,10.98042429875286D,11.097483706684983D,11.214451103637154D,11.33132639499491D,11.448109486564888D,11.564800284576798D,11.681398695685274D,11.797904626971755D,11.914317985946447D,12.030638680550133D,12.146866619156084D,12.263001710571952D,12.379043864041602D,12.49499298924701D,12.610848996310105D,12.726611795794646D,12.842281298708029D,12.957857416503181D,13.073340061080366D,13.188729144789043D,13.304024580429655D,13.419226281255508D,13.534334160974518D,13.6493481337511D,13.764268114207894D,13.879094017427601D,13.993825758954793D,14.108463254797664D,14.223006421429819D,14.337455175792046D,14.451809435294095D,14.566069117816419D,14.680234141711928D,14.794304425807761D,14.908279889406968D,15.022160452290297D,15.135946034717891D,15.249636557431021D,15.363231941653764D,15.476732109094735D,15.590136981948767D,15.703446482898617D,15.81666053511661D,15.929779062266341D,16.042801988504326D,16.15572923848166D,16.26856073734565D,16.3812964107415D,16.49393618481388D,16.606479986208576D,16.718927742074126D,16.8312793800634D,16.943534828335185D,17.055694015555837D,17.16775687090075D,17.27972332405605D,17.391593305220063D,17.503366745104927D,17.6150435749381D,17.726623726463895D,17.83810713194505D,17.949493724164196D,18.060783436425357D,18.171976202555513D,18.283071956906007D,18.394070634354065D,18.504972170304274D,18.61577650069002D,18.72648356197493D,18.83709329115433D,18.947605625756655D,19.05802050384489D,19.168337864017946D,19.278557645412082D,19.388679787702294D,19.49870423110366D,19.608630916372743D,19.718459784808932D,19.828190778255784D,19.93782383910234D,20.047358910284487D,20.156795935286247D,20.266134858141072D,20.37537562343315D,20.484518176298653D,20.59356246242706D,20.702508428062348D,20.811356020004283D,20.92010518560964D,21.028755872793408D,21.13730803003002D,21.24576160635455D,21.354116551363887D,21.462372815217915D,21.570530348640684D,21.678589102921546D,21.78654902991631D,21.89441008204835D,22.002172212309727D,22.10983537426231D,22.217399522038843D,22.324864610344015D,22.432230594455543D,22.539497430225243D,22.646665074080016D,22.75373348302293D,22.860702614634196D,22.967572427072195D,23.074342879074454D,23.18101392995863D,23.28758553962347D,23.394057668549753D,23.500430277801236D,23.606703329025596D,23.712876784455307D,23.818950606908555D,23.92492475979013D,24.03079920709228D,24.1365739133956D,24.24224884386983D,24.34782396427473D,24.453299240960867D,24.558674640870457D,24.663950131538098D,24.769125681091616D,24.874201258252757D,24.979176832337995D,25.084052373259258D,25.188827851524604D,25.29350323823898D,25.398078505104916D,25.50255362442315D,25.606928569093373D,25.711203312614806D,25.815377829086902D,25.919452093209923D,26.023426080285574D,26.127299766217593D,26.231073127512335D,26.33474614127933D,26.43831878523185D,26.54179103768744D,26.645162877568428D,26.74843428440247D,26.85160523832301D,26.954675720069787D,27.057645710989274D,27.160515193035163D,27.263284148768772D,27.365952561359492D,27.468520414585175D,27.570987692832546D,27.67335438109756D,27.7756204649858D,27.877785930712783D,27.979850765104327D,28.08181495559687D,28.183678490237753D,28.285441357685528D,28.387103547210238D,28.48866504869367D,28.59012585262959D,28.691485950123994D,28.79274533289531D,28.89390399327463D,28.99496192420583D,29.095919119245824D,29.19677557256466D,29.297531278945694D,29.398186233785687D,29.49874043309497D,29.599193873497466D,29.699546552230856D,29.799798467146577D,29.899949616709907D,29.999999999999996D,30.09994961670991D,30.19979846714657D,30.299546552230858D,30.39919387349747D,30.498740433094962D,30.598186233785686D,30.697531278945696D,30.79677557256467D,30.89591911924583D,30.99496192420584D,31.093903993274633D,31.192745332895313D,31.291485950123995D,31.39012585262959D,31.48866504869367D,31.587103547210244D,31.68544135768553D,31.78367849023775D,31.881814955596877D,31.97985076510433D,32.077785930712786D,32.175620464985805D,32.27335438109756D,32.37098769283255D,32.468520414585164D,32.565952561359495D,32.66328414876877D,32.76051519303516D,32.857645710989274D,32.95467572006979D,33.05160523832301D,33.14843428440248D,33.24516287756843D,33.341791037687436D,33.43831878523186D,33.53474614127932D,33.63107312751233D,33.7272997662176D,33.82342608028557D,33.91945209320992D,34.0153778290869D,34.1112033126148D,34.206928569093364D,34.302553624423155D,34.39807850510492D,34.49350323823898D,34.588827851524606D,34.684052373259256D,34.779176832338D,34.874201258252754D,34.96912568109161D,35.06395013153811D,35.158674640870466D,35.25329924096087D,35.34782396427473D,35.44224884386983D,35.5365739133956D,35.63079920709229D,35.72492475979013D,35.81895060690856D,35.91287678445531D,36.006703329025605D,36.10043027780124D,36.19405766854975D,36.287585539623464D,36.38101392995863D,36.474342879074456D,36.5675724270722D,36.66070261463419D,36.753733483022934D,36.84666507408002D,36.939497430225245D,37.03223059445555D,37.12486461034401D,37.217399522038846D,37.30983537426232D,37.402172212309736D,37.49441008204835D,37.58654902991631D,37.67858910292155D,37.77053034864068D,37.86237281521792D,37.95411655136389D,38.04576160635455D,38.13730803003002D,38.2287558727934D,38.320105185609634D,38.411356020004284D,38.50250842806235D,38.59356246242706D,38.68451817629865D,38.77537562343315D,38.86613485814107D,38.95679593528625D,39.04735891028449D,39.13782383910233D,39.22819077825578D,39.31845978480894D,39.408630916372736D,39.49870423110366D,39.58867978770229D,39.67855764541208D,39.768337864017944D,39.85802050384489D,39.947605625756665D,40.037093291154335D,40.12648356197493D,40.215776500690026D,40.304972170304275D,40.39407063435406D,40.483071956905995D,40.57197620255552D,40.66078343642536D,40.749493724164196D,40.83810713194506D,40.926623726463895D,41.01504357493809D,41.10336674510493D,41.19159330522006D,41.27972332405604D,41.367756870900756D,41.455694015555835D,41.5435348283352D,41.6312793800634D,41.718927742074115D,41.80647998620857D,41.893936184813874D,41.9812964107415D,42.068560737345656D,42.15572923848166D,42.24280198850432D,42.32977906226635D,42.416660535116606D,42.50344648289862D,42.590136981948774D,42.67673210909473D,42.76323194165376D,42.849636557431026D,42.935946034717894D,43.022160452290294D,43.108279889406965D,43.19430442580776D,43.28023414171193D,43.36606911781642D,43.45180943529409D,43.53745517579205D,43.62300642142982D,43.70846325479767D,43.7938257589548D,43.8790940174276D,43.96426811420789D,44.0493481337511D,44.13433416097453D,44.21922628125551D,44.30402458042967D,44.38872914478904D,44.47334006108037D,44.557857416503175D,44.64228129870803D,44.726611795794646D,44.81084899631011D,44.89499298924702D,44.97904386404161D,45.06300171057195D,45.146866619156086D,45.23063868055013D,45.314317985946445D,45.39790462697176D,45.48139869568526D,45.564800284576805D,45.6481094865649D,45.73132639499491D,45.81445110363716D,45.89748370668498D,45.980424298752865D,46.063272974874494D,46.146029830500915D,46.228694961498526D,46.311268464147204D,46.393750435138436D,46.476140971573294D,46.55844017096051D,46.640648131214625D,46.722764950654D,46.80479072799884D,46.88672556236931D,46.968569553283515D,47.050322800655636D,47.1319854047939D,47.21355746639866D,47.29503908656041D,47.37643036675784D,47.45773140885583D,47.538942315103554D,47.62006318813245D,47.70109413095424D,47.78203524695898D,47.862886639913064D,47.94364841395725D,48.0243206736047D,48.10490352373891D,48.18539706961182D,48.265801416841775D,48.346116671411515D,48.42634293966625D,48.50648032831157D,48.58652894441151D,48.66648889538658D,48.74636028901165D,48.82614323341409D,48.90583783707166D,48.98544420881054D,49.064962457803354D,49.14439269356714D,49.22373502596132D,49.30298956518572D,49.38215642177859D,49.46123570661453D,49.54022753090253D,49.61913200618393D,49.69794924433044D,49.7766793575421D,49.85532245834528D,49.9338786595907D,50.01234807445134D,50.09073081642053D,50.16902699930985D,50.24723673724719D,50.325360144674676D,50.40339733634673D,50.48134842732798D,50.559213532991315D,50.63699276901584D,50.71468625138491D,50.79229409638406D,50.86981642059905D,50.94725334091385D,51.02460497450861D,51.101871438857685D,51.17905285172763D,51.25614933117515D,51.33316099554518D,51.410087963468854D,51.48693035386145D,51.563688285920506D,51.640361879123695D,51.71695125322695D,51.79345652826242D,51.86987782453646D,51.94621526262769D,52.022468963384966D,52.09863904792544D,52.17472563763253D,52.25072885415398D,52.32664881939987D,52.40248565554064D,52.47823948500509D,52.55391043047848D,52.629498614900484D,52.70500416146327D,52.78042719360952D,52.85576783503046D,52.93102620966396D,53.00620244169248D,53.08129665554124D,53.15630897587611D,53.23123952760185D,53.306088435860026D,53.38085582602714D,53.455541823712636D,53.530146554757046D,53.60467014522998D,53.67911272142825D,53.753474409873924D,53.82775533731242D,53.901955630710546D,53.97607541725466D,54.05011482434871D,54.124073979612305D,54.197953010878905D,54.271752046193804D,54.34547121381232D,54.41911064219787D,54.49267046002009D,54.566150796152975D,54.63955177967294D,54.71287353985699D,54.78611620618086D,54.8592799083171D,54.93236477613327D,55.005370939690025D,55.07829852923931D,55.15114767522249D,55.223918508268476D,55.296611159191954D,55.369225758991476D,55.44176243884767D,55.5142213301214D,55.58660256435198D,55.65890627325528D,55.73113258872198D,55.80328164281572D,55.87535356777134D,55.94734849599306D,56.01926656005267D,56.09110789268777D,56.162872626799974D,56.234560895453114D,56.30617283187153D,56.3777085694382D,56.449168241693094D,56.52055198233131D,56.59185992520141D,56.66309220430362D,56.73424895378808D,56.80533030795318D,56.876336401243734D,56.947267368249335D,57.018123343702584D,57.088904462477394D,57.1596108595873D,57.230242670183735D,57.3008000295543D,57.371283073121184D,57.44169193643933D,57.51202675519484D,57.58228766520333D,57.65247480240821D,57.72258830287901D,57.79262830280974D,57.86259493851729D,57.93248834643972D,58.00230866313458D,58.07205602527748D,58.141730569660176D,58.21133243318917D,58.28086175288403D,58.35031866587573D,58.41970330940515D,58.48901582082133D,58.55825633758005D,58.62742499724215D,58.696521937471935D,58.76554729603567D,58.83450121079998D,58.903383819730294D,58.972195260889244D,59.040935672435246D,59.10960519262082D,59.17820395979117D,59.24673211238254D,59.31518978892083D,59.38357712801995D,59.45189426838042D,59.52014134878778D,59.58831850811118D,59.65642588530183D,59.724463619391535D,59.79243184949121D,59.860330714789484D,59.92816035455111D,59.99592090811563D,60.06361251489585D,60.13123531437643D,60.19878944611245D,60.26627504972798D,60.33369226491464D,60.40104123143023D,60.46832208909724D,60.53553497780156D,60.602680037490984D,60.66975740817387D,60.736767229917774D,60.80370964284802D,60.87058478714639D,60.93739280304975D,61.004133830848644D,61.07080801088604D,61.13741548355589D,61.20395638930192D,61.27043086861614D,61.33683906203764D,61.4031811101513D,61.46945715358638D,61.53566733301531D,61.60181178915233D,61.667890662752264D,61.73390409460921D,61.79985222555527D,61.8657351964593D,61.93155314822564D,61.99730622179286D,62.06299455813254D,62.128618298247986D,62.19417758317306D,62.25967255397092D,62.3251033517328D,62.390470117576825D,62.4557729926468D,62.521012118111D,62.586187635161004D,62.65129968501051D,62.71634840889411D,62.78133394806625D,62.84625644379992D,62.91111603738559D,62.97591287013006D,63.04064708335526D,63.105318818397215D,63.16992821660483D,63.234475419338814D,63.298960567970546D,63.36338380388103D,63.427745268459745D,63.49204510310349D,63.55628344921548D,63.62046044820409D,63.68457624148189D,63.74863097046455D,63.81262477656977D,63.87655780121625D,63.94043018582265D,64.00424207180654D,64.06799360058342D,64.13168491356559D,64.19531615216125D,64.25888745777345D,64.32239897179907D,64.38585083562785D,64.44924319064138D,64.5125761782122D,64.57584993970266D,64.63906461646414D,64.70222034983598D,64.76531728114458D,64.82835555170237D,64.891335302807D,64.95425667574027D,65.01711981176733D,65.0799248521357D,65.14267193807434D,65.20536121079277D,65.26799281148018D,65.33056688130453D,65.39308356141167D,65.45554299292445D,65.51794531694183D,65.58029067453808D,65.64257920676187D,65.70481105463543D,65.76698635915372D,65.82910526128353D,65.89116790196279D,65.95317442209955D,66.01512496257136D,66.07701966422431D,66.1388586678723D,66.2006421142962D,66.26237014424314D,66.32404289842559D,66.38566051752072D,66.44722314216953D,66.50873091297615D,66.57018397050705D,66.63158245529024D,66.69292650781468D,66.75421626852932D,66.81545187784255D,66.87663347612141D,66.93776120369084D,66.99883520083301D,67.05985560778659D,67.12082256474606D,67.18173621186102D,67.24259668923547D,67.30340413692718D,67.36415869494698D,67.42486050325807D,67.48550970177543D,67.54610643036509D,67.6066508288435D,67.66714303697692D,67.72758319448076D,67.78797144101893D,67.8483079162032D,67.90859275959271D,67.96882611069312D,68.02900810895623D,68.0891388937793D,68.1492186045044D,68.20924738041788D,68.26922536074979D,68.32915268467325D,68.38902949130397D,68.4488559196996D,68.50863210885919D,68.56835819772272D,68.62803432517038D,68.68766063002222D,68.7472372510375D,68.8067643269142D,68.8662419962885D,68.92567039773418D,68.98504966976226D,69.04437995082041D,69.1036613792924D,69.16289409349773D,69.22207823169099D,69.28121393206156D,69.34030133273295D,69.39934057176245D,69.45833178714065D,69.51727511679091D,69.576170698569D,69.63501867026258D,69.69381916959078D,69.75257233420379D,69.81127830168242D,69.8699372095376D,69.92854919521007D,69.98711439606991D,70.04563294941612D,70.10410499247624D,70.16253066240596D,70.22091009628866D,70.27924343113513D,70.33753080388311D,70.39577235139693D,70.45396821046714D,70.51211851781014D,70.57022341006787D,70.62828302380731D,70.68629749552039D,70.74426696162331D,70.80219155845651D,70.86007142228411D,70.91790668929374D,70.97569749559608D,71.03344397722468D,71.0911462701355D,71.14880451020672D,71.20641883323839D,71.2639893749521D,71.3215162709908D,71.3789996569183D,71.43643966821924D,71.4938364402986D,71.55119010848156D,71.60850080801318D,71.66576867405813D,71.72299384170043D,71.78017644594325D,71.83731662170858D,71.89441450383704D,71.9514702270876D,72.00848392613742D,72.0654557355815D,72.1223857899326D,72.1792742236209D,72.23612117099378D,72.29292676631577D,72.34969114376815D,72.40641443744882D,72.46309678137217D,72.51973830946878D,72.57633915558526D,72.63289945348416D,72.68941933684364D,72.7458989392574D,72.80233839423454D,72.85873783519922D,72.9150973954907D,72.97141720836306D,73.02769740698514D,73.08393812444024D,73.14013949372618D,73.19630164775498D,73.25242471935282D,73.30850884125994D,73.36455414613036D,73.42056076653196D,73.47652883494621D,73.53245848376812D,73.58834984530613D,73.64420305178199D,73.70001823533066D,73.7557955280002D,73.81153506175173D,73.86723696845932D,73.9229013799098D,73.97852842780286D,74.03411824375087D,74.08967095927876D,74.14518670582409D,74.20066561473688D,74.25610781727956D,74.31151344462694D,74.36688262786615D,74.42221549799662D,74.47751218592992D,74.53277282248992D,74.58799753841252D,74.64318646434582D,74.69833973084997D,74.75345746839714D,74.80853980737159D,74.8635868780696D,74.91859881069938D,74.97357573538119D,75.02851778214728D,75.08342508094184D,75.13829776162105D,75.19313595395307D,75.2479397876181D,75.30270939220826D,75.35744489722771D,75.4121464320927D,75.46681412613144D,75.52144810858428D,75.57604850860368D,75.63061545525419D,75.68514907751256D,75.73964950426777D,75.79411686432105D,75.8485512863859D,75.90295289908815D,75.95732183096611D,76.01165821047046D,76.06596216596445D,76.12023382572387D,76.17447331793718D,76.22868077070554D,76.28285631204287D,76.33700006987597D,76.39111217204454D,76.44519274630134D,76.4992419203122D,76.55325982165616D,76.60724657782548D,76.66120231622588D,76.71512716417647D,76.76902124890998D,76.82288469757275D,76.87671763722497D,76.93052019484064D,76.98429249730783D,77.0380346714287D,77.09174684391957D,77.14542914141121D,77.1990816904488D,77.25270461749218D,77.30629804891585D,77.35986211100919D,77.41339692997663D,77.46690263193769D,77.52037934292716D,77.57382718889528D,77.62724629570783D,77.68063678914632D,77.73399879490813D,77.78733243860663D,77.84063784577144D,77.89391514184842D,77.94716445220004D,78.00038590210535D,78.05357961676027D,78.10674572127773D,78.15988434068782D,78.21299559993803D,78.26607962389329D,78.31913653733635D,78.37216646496778D,78.42516953140628D,78.4781458611888D,78.53109557877075D,78.58401880852618D,78.63691567474804D,78.6897863016483D,78.74263081335816D,78.7954493339283D,78.84824198732906D,78.90100889745065D,78.95375018810331D,79.00646598301765D,79.05915640584469D,79.11182158015626D,79.16446162944507D,79.21707667712502D,79.26966684653141D,79.32223226092108D,79.37477304347283D,79.42728931728745D,79.479781205388D,79.53224883072018D,79.5846923161524D,79.63711178447613D,79.68950735840606D,79.7418791605804D,79.79422731356108D,79.84655193983409D,79.89885316180957D,79.9511311018223D,80.00338588213164D,80.05561762492208D,80.10782645230334D,80.16001248631066D,80.21217584890509D,80.26431666197371D,80.3164350473299D,80.36853112671369D,80.4206050217919D,80.47265685415854D,80.52468674533496D,80.57669481677026D,80.62868118984139D,80.68064598585366D,80.73258932604081D,80.78451133156543D,80.83641212351914D,80.88829182292297D,80.94015055072762D,80.99198842781372D,81.04380557499213D,81.0956021130043D,81.14737816252243D,81.19913384414991D,81.25086927842158D,81.30258458580391D,81.3542798866955D,81.40595530142724D,81.45761095026269D,81.50924695339833D,81.56086343096389D,81.61246050302273D,81.66403828957202D,81.71559691054317D,81.76713648580207D,81.81865713514946D,81.87015897832124D,81.92164213498872D,81.97310672475906D,82.0245528671755D,82.07598068171772D,82.1273902878022D,82.17878180478243D,82.23015535194938D,82.28151104853178D,82.33284901369639D,82.38416936654845D,82.43547222613186D,82.4867577114297D,82.53802594136444D,82.5892770347983D,82.64051111053364D,82.69172828731321D,82.74292868382061D,82.79411241868056D,82.8452796104592D,82.8964303776646D,82.94756483874693D,82.9986831120989D,83.04978531605614D,83.10087156889745D,83.15194198884527D,83.2029966940659D,83.25403580267003D,83.30505943271295D,83.35606770219493D,83.40706072906173D,83.45803863120466D,83.50900152646128D,83.55994953261553D,83.61088276739821D,83.66180134848726D,83.71270539350824D,83.76359502003457D,83.81447034558798D,83.86533148763887D,83.91617856360668D,83.96701169086023D,84.01783098671814D,84.06863656844918D,84.11942855327261D,84.17020705835866D,84.22097220082878D,84.27172409775613D,84.3224628661659D,84.37318862303567D,84.42390148529583D,84.47460156983D,84.5252889934753D,84.5759638730229D,84.62662632521817D,84.67727646676136D,84.72791441430769D,84.778540284468D,84.82915419380893D,84.87975625885346D,84.93034659608122D,84.98092532192888D,85.0314925527906D,85.08204840501837D,85.13259299492243D,85.18312643877168D,85.233648852794D,85.28416035317673D,85.33466105606708D,85.38515107757243D,85.4356305337608D,85.48609954066126D,85.53655821426428D,85.5870066705222D,85.63744502534954D,85.6878733946235D,85.73829189418427D,85.78870063983554D,85.83909974734483D,85.88948933244389D,85.93986951082918D,85.99024039816216D,86.04060211006981D,86.09095476214505D,86.14129846994697D,86.19163334900148D,86.24195951480154D,86.29227708280766D,86.34258616844829D,86.39288688712023D,86.44317935418907D,86.4934636849895D,86.54373999482591D,86.59400839897265D,86.64426901267444D,86.69452195114697D,86.74476732957703D,86.79500526312322D,86.84523586691616D,86.89545925605897D,86.94567554562778D,86.99588485067196D,87.04608728621473D,87.09628296725347D,87.14647200876017D,87.19665452568185D,87.24683063294098D,87.2970004454359D,87.34716407804129D,87.39732164560849D,87.447473262966D,87.4976190449199D,87.54775910625429D,87.59789356173164D,87.64802252609327D,87.6981461140598D,87.74826444033151D,87.79837761958879D,87.84848576649266D,87.89858899568499D,87.94868742178917D,87.99878115941031D,88.04887032313587D,88.09895502753596D,88.14903538716379D,88.19911151655613D,88.24918353023372D,88.2992515427017D,88.34931566845006D,88.39937602195403D,88.44943271767454D,88.49948587005865D,88.54953559353999D,88.59958200253912D,88.64962521146408D,88.69966533471076D,88.7497024866633D,88.79973678169452D,88.8497683341665D,88.89979725843077D,88.94982366882897D,88.99984767969313D,89.04986940534619D,89.09988896010238D,89.14990645826767D,89.19992201414021D,89.24993574201079D,89.29994775616323D,89.34995817087483D,89.39996710041679D,89.44997465905466D,89.4999809610488D,89.54998612065478D,89.5999902521238D,89.64999346970315D,89.69999588763666D,89.74999762016509D,89.79999878152661D,89.84999948595723D,89.89999984769118D,89.94999998096141D,870.0D};
    
    @Override
    public StreamObserver<MissileState> getGuidance(final StreamObserver<ControlInput> controlInputObserver) {
      return new StreamObserver<MissileState>() {
        private int id = 0;

        double init_pitch = 0;
        double init_yaw = 0;
        double speed = 0;

        int targetId = 0;
        double[][] target = new double[100][3];
        boolean boom = false;

        double[] unit = {0.0D,1.0D,2.0D};
        double[] x0 = {50D,0D,0D};
        double[] x1 = {100D,400D,100D};
        double[] x2 = {50D,0D,0D};

        public CubicSpline[] generateSpline(double[] x, double[] y, double[] z, double[] unit) {
          CubicSpline[] spline = new CubicSpline[3];
          spline[0] = new CubicSpline(unit, x);
          spline[1] = new CubicSpline(unit, y);
          spline[2] = new CubicSpline(unit, z);
          spline[0].calcDeriv();
          spline[1].calcDeriv();
          spline[2].calcDeriv();
          return spline;
        }

        public double[] interpolate3D(CubicSpline[] spline, double unit) {
          double[] pos = new double[3];
          pos[0] = spline[0].interpolate(unit);
          pos[1] = spline[1].interpolate(unit);
          pos[2] = spline[2].interpolate(unit);
          return pos;
        }

        public double length(double x, double y, double z) {
          return Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2) + Math.pow(y, 2));
        }

        public double[][] StringToCoords(String name) {
            String[] singleCoord = name.split("->");
            double[][] targets = new double[singleCoord.length][3];
            for(int i = 0; i < singleCoord.length; i++) {
              String[] xyz = singleCoord[i].split("#");
              for(int j = 0; j < 3; j++) {
                targets[i][j] = Double.parseDouble(xyz[j]);
                if(targets[i][j] >= 0) {
                  targets[i][j] += 0.5D;
                } else {
                  targets[i][j] -= 0.5D;
                }
              }
            }
            return targets;
        }

        @Override
        public void onNext(MissileState missileState) {
          //CubicSpline[] test = generateSpline(x0,x1,x2,unit);
          //double[] testpos = interpolate3D(test, 1.5D);
          //logger.log(Level.INFO, "test x y z " + testpos[0] + " " +testpos[1] + " "+ testpos[2]);

          //Speed-Regulation
          speed = length(missileState.getVelX(),missileState.getVelY(),missileState.getVelZ());
          //logger.log(Level.INFO, "################################## speed " + speed);

          //logger.log(Level.INFO, "################################## Name " + missileState.getMissile().getName());
          target = StringToCoords(missileState.getMissile().getName());
          //logger.log(Level.INFO, "####### targets " + target[0][0] + "-" + target[0][1] + "-" + target[0][2] + "   " + target[1][0] + "-" + target[1][1] + "-" + target[1][2]);

          //Target Coords
          double dif_x = target[targetId][0] - (missileState.getPosX() + missileState.getVelX());
          double dif_y = target[targetId][1] - (missileState.getPosY() + missileState.getVelY());
          double dif_z = target[targetId][2] - (missileState.getPosZ() + missileState.getVelZ());
          double len = length(dif_x, dif_y, dif_z);
          
          init_yaw = -(90 + Math.toDegrees(Math.atan(dif_z/dif_x)));
          if (dif_x > 0) {
            init_yaw +=180;
          }
          double hyp_xz = Math.sqrt(Math.pow(dif_x, 2) + Math.pow(dif_z, 2));
          init_pitch = 90 - Math.toDegrees(Math.atan(hyp_xz/dif_y));
          if (init_pitch > 90) {
            init_pitch -= 180;
          }
          init_pitch = angleToGravityAngle[(int)(Math.round(init_pitch) * 10) + 900];
          //logger.log(Level.INFO, "################################## yaw " + init_yaw);
          //logger.log(Level.INFO, "################################## pitch " + init_pitch);

          //Change Target/What to do at Target
          if (len <= 5 && targetId <= 1) {
            //targetId++;
          }

          logger.log(Level.INFO, "received missileState, pos " + missileState.getPosX() + " " + missileState.getPosY() + " " + missileState.getPosZ());

          // send control to missile
          var controlInput = ControlInput.newBuilder().setId(id++).setPitchTurn(init_pitch - missileState.getPitch()).setYawTurn(init_yaw - missileState.getYaw()).setExplode(false).setDisarm(false).setHardwareConfig(
                        MissileHardwareConfig.newBuilder()
                          .setWarhead(MissileHardwareConfig.Warhead.TNT_M)
                          .setAirframe(MissileHardwareConfig.Airframe.DEFAULT_AIRFRAME)
                          .setMotor(MissileHardwareConfig.Motor.SINGLE_STAGE_M)
                          .setBattery(MissileHardwareConfig.Battery.LI_ION_M)
                          .setSeeker(MissileHardwareConfig.Seeker.NO_SEEKER)
                          .setInertialSystem(MissileHardwareConfig.InertialSystem.DEFAULT_IMU)
                          .build()).build();
          controlInputObserver.onNext(controlInput);
        }

        @Override
        public void onError(Throwable t) {
          logger.log(Level.WARNING, "getGuidance error");
        }

        @Override
        public void onCompleted() {
          controlInputObserver.onCompleted();
        }
      };
    }

    @Override
    public void healthCheck(HealthRequest request, StreamObserver<HealthResponse> responseObserver) {
        // don't do anything
        responseObserver.onNext(HealthResponse.newBuilder().build());
    }
  }
}
